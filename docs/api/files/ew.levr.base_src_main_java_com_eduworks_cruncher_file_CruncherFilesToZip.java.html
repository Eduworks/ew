<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ew.levr.base/src/main/java/com/eduworks/cruncher/file/CruncherFilesToZip.java - EW Library</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div class="yui3-g">
        <div id="sidebar" class="yui3-u">
            <div class="logo">
              <a href="../index.html">
                  <img src="http://eduworks.com/img/eduworks-ring-e.png">
              </a>
            </div>
            
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/ew.levr.base.html">ew.levr.base</a>
                            </li>
                            <li><a href="../modules/ew.levr.rdf.html">ew.levr.rdf</a>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/add.html">add</a></li>
                            <li><a href="../classes/base64ToFile.html">base64ToFile</a></li>
                            <li><a href="../classes/cache.html">cache</a></li>
                            <li><a href="../classes/createDirectory.html">createDirectory</a></li>
                            <li><a href="../classes/deserialize.html">deserialize</a></li>
                            <li><a href="../classes/fileDelete.html">fileDelete</a></li>
                            <li><a href="../classes/fileExists.html">fileExists</a></li>
                            <li><a href="../classes/fileHash.html">fileHash</a></li>
                            <li><a href="../classes/fileList.html">fileList</a></li>
                            <li><a href="../classes/fileLoad.html">fileLoad</a></li>
                            <li><a href="../classes/filename.html">filename</a></li>
                            <li><a href="../classes/filepath.html">filepath</a></li>
                            <li><a href="../classes/fileSave.html">fileSave</a></li>
                            <li><a href="../classes/fileSize.html">fileSize</a></li>
                            <li><a href="../classes/fileToBase64.html">fileToBase64</a></li>
                            <li><a href="../classes/fileToString.html">fileToString</a></li>
                            <li><a href="../classes/jsonLdCompact.html">jsonLdCompact</a></li>
                            <li><a href="../classes/jsonLdExpand.html">jsonLdExpand</a></li>
                            <li><a href="../classes/null.html">null</a></li>
                            <li><a href="../classes/variableGet.html">variableGet</a></li>
                            <li><a href="../classes/variableSet.html">variableSet</a></li>
                            <li><a href="../classes/wsBroadcast.html">wsBroadcast</a></li>
                            <li><a href="../classes/wsEmit.html">wsEmit</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div class="version-info">
              Version: 5.1.0
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><div class="title">
  <h1 class="file-name">ew.levr.base/src/main/java/com/eduworks/cruncher/file/CruncherFilesToZip.java</h1>
</div>

<pre class="code prettyprint linenums">
package com.eduworks.cruncher.file;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.commons.io.output.ByteArrayOutputStream;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.w3c.dom.Document;

import com.eduworks.resolver.Context;
import com.eduworks.resolver.Cruncher;
import com.eduworks.util.io.EwFileSystem;
import com.eduworks.util.io.InMemoryFile;

/**
 * Zips either a Map&lt;String,?&gt;, a JSONObject composed of &quot;filename&quot;:&quot;UTF-8 encoded string&quot; or a JSONArray of files.
 * TODO: sDoes not support streaming, large file operations may require modification of this Cruncher.
 *
 * rs2: obj = obj.filepath(); levrJs: obj = filepame.call(this,obj);
 *
 * @class filepath
 * @module ew.levr.base
 * @author fritz.ray@eduworks.com
 */
public class CruncherFilesToZip extends Cruncher {

    @Override
    public Object resolve(Context c, Map&lt;String, String[]&gt; parameters, Map&lt;String, InputStream&gt; dataStreams) throws JSONException {
        Object obj = getObj(c, parameters, dataStreams);
        Map&lt;String, ?&gt; files = null;
        if (obj instanceof Map)
            files = (Map&lt;String, ?&gt;) obj;
        else if (obj instanceof JSONObject) {
            JSONObject jo = (JSONObject) obj;
            Map&lt;String, Object&gt; m = new HashMap&lt;String, Object&gt;();
            for (Iterator&lt;String&gt; it = jo.keys(); it.hasNext();) {
                String s = it.next();
                m.put(s, jo.get(s));
            }
            files = m;
        } else if (obj instanceof JSONArray) {
            JSONArray ja = (JSONArray) obj;
            Map&lt;String, Object&gt; m = new HashMap&lt;String, Object&gt;();
            for (int i = 0; i &lt; ja.length(); i++) {
                Object object = ja.get(i);
                if (object instanceof InMemoryFile) {
                    InMemoryFile imf = (InMemoryFile) object;
                    m.put(imf.name, imf);
                } else if (object instanceof File) {
                    File f = (File) object;
                    m.put(f.getName(), f);
                }
            }
            files = m;
        }

        File f;
        try {
            f = File.createTempFile(&quot;foo&quot;, &quot;zip&quot;);
        } catch (IOException e1) {
            throw new RuntimeException(&quot;Cannot create temp file.&quot;);
        }

        byte[] buf = new byte[4096];

        try {
            ZipOutputStream out = new ZipOutputStream(new FileOutputStream(f));

            for (String filename : files.keySet()) {
                Object value = files.get(filename);
                if (value instanceof InMemoryFile) {
                    InMemoryFile fi = (InMemoryFile) value;

                    if (fi.name == null)
                        out.putNextEntry(new ZipEntry(filename));
                    else
                        out.putNextEntry(new ZipEntry(fi.name));

                    out.write(fi.data);
                } else if (value instanceof File) {
                    File fi = (File) value;

                    out.putNextEntry(new ZipEntry(filename));

                    out.write(FileUtils.readFileToByteArray(fi));
                } else {
                    String realFilename = filename + getExt(value);

                    out.putNextEntry(new ZipEntry(realFilename));

                    out.write(toByteArray(value));
                }
                out.closeEntry();
            }

            out.close();
        } catch (IOException e) {
        }
        InMemoryFile fi = new InMemoryFile();
        try {
            fi.data = IOUtils.toByteArray(new FileInputStream(f));
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } catch (IOException e) {
            e.printStackTrace();
        }
        fi.mime = &quot;application/zip&quot;;
        fi.name = getAsString(&quot;name&quot;, c, parameters, dataStreams);
        EwFileSystem.deleteEventually(f);
        return fi;
    }

    private byte[] toByteArray(Object value) {
        if (value instanceof Document)
            try {
                /* Create a transformation factory */
                TransformerFactory tf = TransformerFactory.newInstance();

                /* Create and configure a transformation factory */
                Transformer t = tf.newTransformer();
                t.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);
                t.setOutputProperty(OutputKeys.ENCODING, &quot;UTF-8&quot;);
                t.setOutputProperty(OutputKeys.STANDALONE, &quot;yes&quot;);

                ByteArrayOutputStream baos;
                /* Write out and transform the document as we do so */
                StreamResult result = new StreamResult(new OutputStreamWriter(baos = new ByteArrayOutputStream(),
                        &quot;utf-8&quot;));

                t.transform(new DOMSource((Document) value), result);
                return baos.toByteArray();
            } catch (TransformerException e) {
                e.printStackTrace();
            } catch (UnsupportedEncodingException e) {
                e.printStackTrace();
            }
        if (value instanceof String)
            return value.toString().getBytes();
        return new byte[0];
    }

    private String getExt(Object value) {
        if (value instanceof Document)
            return &quot;.html&quot;;
        return &quot;&quot;;
    }

    @Override
    public String getDescription() {
        return &quot;Takes a bundle of files specified by paths defined by nested JSON objects and finally ResolverFiles (or Files or Strings) and zips them up.&quot;;
    }

    @Override
    public String getReturn() {
        return &quot;InMemoryFile&quot;;
    }

    @Override
    public String getAttribution() {
        return ATTRIB_TRADEM1;
    }

    @Override
    public JSONObject getParameters() throws JSONException {
        return jo(&quot;obj&quot;, &quot;JSONObject&quot;);
    }
}

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
</body>
</html>
